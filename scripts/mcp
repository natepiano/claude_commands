#!/bin/bash

# Unified MCP server management script for Claude configuration
# Manages adding/removing MCP servers from ~/.claude.json using definitions in ~/.claude/config/mcp.json

set -euo pipefail

# Configuration
CONFIG_FILE="$HOME/.claude.json"
MCP_CONFIG_FILE="$HOME/.claude/config/mcp.json"
BACKUP_DIR="$HOME/.claude_backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/claude.json.bak_${TIMESTAMP}"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to display usage
usage() {
    echo "Usage: mcp [--add|-a|--remove|-r] <server-name>"
    echo ""
    echo "Manage MCP servers in Claude configuration"
    echo ""
    echo "Options:"
    echo "  --add, -a <name>     Add MCP server from config"
    echo "  --remove, -r <name>  Remove MCP server from config"
    echo ""

    # Show currently configured servers
    echo -e "${GREEN}Currently configured servers:${NC}"
    if [ -f "$CONFIG_FILE" ]; then
        CONFIGURED=$(jq -r '.mcpServers // {} | keys[]' "$CONFIG_FILE" 2>/dev/null)
        if [ -n "$CONFIGURED" ]; then
            echo "$CONFIGURED" | sed 's/^/  ✓ /'
        else
            echo "  (none)"
        fi
    else
        echo "  (config file not found)"
    fi
    echo ""

    # Show available servers
    echo -e "${BLUE}Available servers (defined in ~/.claude/config/mcp.json):${NC}"
    if [ -f "$MCP_CONFIG_FILE" ]; then
        if [ -f "$CONFIG_FILE" ]; then
            # Get configured servers for comparison
            CONFIGURED=$(jq -r '.mcpServers // {} | keys[]' "$CONFIG_FILE" 2>/dev/null || echo "")

            # List all available servers with status
            jq -r 'keys[]' "$MCP_CONFIG_FILE" 2>/dev/null | while read -r server; do
                if echo "$CONFIGURED" | grep -q "^${server}$"; then
                    echo "  ✓ $server (configured)"
                else
                    echo "  - $server"
                fi
            done
        else
            jq -r 'keys[]' "$MCP_CONFIG_FILE" 2>/dev/null | sed 's/^/  - /' || echo "  (unable to list servers)"
        fi
    else
        echo "  (config file not found)"
    fi
    echo ""
    echo "Examples:"
    echo "  mcp --add blender      # Add blender MCP server"
    echo "  mcp -r brp             # Remove brp MCP server"
    exit 1
}

# Check for jq
if ! command -v jq &> /dev/null; then
    echo -e "${RED}Error: jq is required but not installed${NC}"
    echo ""
    echo "Please install jq:"
    echo "  macOS:   brew install jq"
    echo "  Ubuntu:  sudo apt-get install jq"
    echo "  Fedora:  sudo dnf install jq"
    exit 1
fi

# Parse arguments
if [ $# -ne 2 ]; then
    usage
fi

OPERATION=""
SERVER_NAME=""

case "$1" in
    --add|-a)
        OPERATION="add"
        SERVER_NAME="$2"
        ;;
    --remove|-r)
        OPERATION="remove"
        SERVER_NAME="$2"
        ;;
    *)
        echo -e "${RED}Error: Unknown option '$1'${NC}"
        echo ""
        usage
        ;;
esac

# Validate that config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}Error: $CONFIG_FILE not found${NC}"
    exit 1
fi

# Validate that MCP config file exists
if [ ! -f "$MCP_CONFIG_FILE" ]; then
    echo -e "${RED}Error: MCP configuration file not found: $MCP_CONFIG_FILE${NC}"
    echo "Please create the configuration file with your MCP server definitions."
    exit 1
fi

# Validate that server exists in MCP config
if ! jq -e ".\"$SERVER_NAME\"" "$MCP_CONFIG_FILE" > /dev/null 2>&1; then
    echo -e "${RED}Error: Server '$SERVER_NAME' not found in $MCP_CONFIG_FILE${NC}"
    echo ""
    echo "Available servers:"
    jq -r 'keys[]' "$MCP_CONFIG_FILE" | sed 's/^/  - /'
    exit 1
fi

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Create backup
echo -e "${GREEN}Creating backup at: $BACKUP_FILE${NC}"
cp "$CONFIG_FILE" "$BACKUP_FILE"

# Perform operation
if [ "$OPERATION" = "add" ]; then
    echo -e "${YELLOW}Adding '$SERVER_NAME' MCP server to Claude configuration...${NC}"

    # Check if server already exists in config
    if jq -e ".mcpServers.\"$SERVER_NAME\"" "$CONFIG_FILE" > /dev/null 2>&1; then
        echo -e "${YELLOW}Warning: '$SERVER_NAME' MCP server already exists in configuration${NC}"
        echo -e "${BLUE}Current configuration:${NC}"
        jq ".mcpServers.\"$SERVER_NAME\"" "$CONFIG_FILE"
        echo ""
        read -p "Do you want to replace it? (y/n): " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Aborted. No changes made."
            exit 0
        fi
    fi

    # Get server config from mcp.json
    SERVER_CONFIG=$(jq ".\"$SERVER_NAME\"" "$MCP_CONFIG_FILE")

    # Add server to .claude.json
    jq --argjson server "$SERVER_CONFIG" ".mcpServers.\"$SERVER_NAME\" = \$server" "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

    echo -e "${GREEN}✓ Backup saved to: $BACKUP_FILE${NC}"
    echo -e "${GREEN}✓ '$SERVER_NAME' MCP server added to configuration${NC}"
    echo ""
    echo -e "${BLUE}Added configuration:${NC}"
    jq ".mcpServers.\"$SERVER_NAME\"" "$CONFIG_FILE"
    echo ""
    echo -e "${YELLOW}Note: You may need to restart Claude for the changes to take effect.${NC}"

elif [ "$OPERATION" = "remove" ]; then
    echo -e "${YELLOW}Removing '$SERVER_NAME' MCP server from Claude configuration...${NC}"

    # Check if server exists in config
    if ! jq -e ".mcpServers.\"$SERVER_NAME\"" "$CONFIG_FILE" > /dev/null 2>&1; then
        echo -e "${YELLOW}Warning: '$SERVER_NAME' MCP server not found in configuration${NC}"
        echo "No changes made."
        exit 0
    fi

    # Remove server from .claude.json
    jq "del(.mcpServers.\"$SERVER_NAME\")" "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

    echo -e "${GREEN}✓ Backup saved to: $BACKUP_FILE${NC}"
    echo -e "${GREEN}✓ '$SERVER_NAME' MCP server removed from configuration${NC}"
fi

echo ""
echo "To restore from backup, run:"
echo "  cp $BACKUP_FILE $CONFIG_FILE"
